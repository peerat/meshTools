meshTalk — compression_documentation

Дата обновления: 2026-02-12

1) Общий пайплайн
- Вход: UTF-8 текст.
- Этап 1: нормализация (опционально, обратимая).
- Этап 2: компрессия (алгоритм/режим).
- Этап 3: упаковка в MC/compact payload и шифрование MT-WIRE.

2) Нормализация
Режимы:
- `OFF` — без предобработки.
- `TOKENS` — обратимый token-stream.
- `SP_VOCAB` — обратимая нормализация по SentencePiece vocab.
- `AUTO` — перебор вариантов нормализации и выбор по наименьшему packed size.

3) Алгоритмы компрессии
- BYTE_DICT
- FIXED_BITS
- DEFLATE
- ZLIB
- BZ2
- LZMA
- ZSTD

4) Политики выбора
- `OFF`: компрессия отключена.
- `FORCE`: строго выбранный алгоритм (если поддерживается пиром).
- `AUTO`: конкурентный выбор лучшего packed варианта.

4.1) Режим `AUTO + AUTO` (нормализация + компрессия)
- Сначала берется исходный текст без нормализации (`OFF`).
- Затем последовательно пробуются доступные нормализации (`TOKENS`, `SP_VOCAB`, ...).
- Для каждого нормализованного варианта пробуются доступные компрессоры (`DEFLATE`, `BZ2`, `LZMA`, `ZSTD`, ...).
- Сравнивается итоговый размер `packed` у всех комбинаций.
- Выбирается комбинация с минимальным `packed`.
- Если ни одна комбинация не дает выгоду, отправка идет без сжатия (`cmp=none`).
- В статусе отображается финальный выбор, например:
  - `TOKEN_STREAM сжатие ZSTD 31.4%`
  - Это означает: после выбранной нормализации и компрессии размер стал `31.4% от исходного`.

5) Совместимость
- Режим применяется только при поддержке peer (capabilities `mc_modes`, `mt_msg/mt_mc`).
- При отсутствии поддержки система откатывается к безопасному варианту (AUTO/plain).

6) Метрики эффективности
- `plain` — исходный размер байт.
- `packed` — размер после нормализации+сжатия.
- `size%` — сколько осталось от исходного (`packed/plain * 100`).
- В GUI используется формулировка вида:
  - `<NORM> сжатие <ALGO> <PCT>%`
  - пример: `TOKEN_STREAM сжатие ZSTD 31.4%`.

7) Агрегированная статистика
- `COMPSTAT`: total/compressed/ratio/plain/packed/size/top_mode/top_norm.
- `COMPRESS`: per-message выбор и итог.
- `NORM`: телеметрия этапа нормализации.

8) Важно про обычный Meshtastic канал
- Для `transport=meshtastic_text` компрессия/нормализация этого модуля не применяются.
- Статус таких сообщений в UI упрощен и показывает только время:
  - исходящее: `отправлено в HH:MM`,
  - входящее: `пришло в HH:MM`.
