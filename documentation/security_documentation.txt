meshTalk — security_documentation

Дата обновления: 2026-02-12

1) Криптографические примитивы (текущая реализация)
- Обмен публичными ключами: X25519 (32 bytes, base64 в KR1/KR2).
- Выработка ключа сессии: HKDF-SHA256.
- Шифрование wire-пакета: AES-256-GCM (`MT-WIREv1`).
- Хранение секретов на диске: AES-256-GCM (ключ в `keyRings/storage.key`).

2) Модель доверия
- TOFU + pinning: первый принятый публичный ключ пира закрепляется локально.
- При смене ключа пира возникает `pinned key mismatch`.

3) Политики смены ключа (`security_key_rotation_policy`)
- `AUTO`:
  - автопринятие только если старый закрепленный ключ никогда не был подтвержден.
  - если был подтвержден — нужен ручной reset/replace.
- `STRICT`:
  - любое изменение ключа требует ручного действия пользователя.
- `ALWAYS`:
  - изменение ключа принимается автоматически (минимум трения, максимум риска подмены).

4) Подтверждение обмена
- Статус считается подтвержденным после `KEYOK`:
  - `confirmed_by=resp` (получен KR2-ответ), или
  - `confirmed_by=payload` (расшифрован полезный payload после обмена).

5) Сценарии ошибок/рисков
- `KEY: pinned key mismatch ...`
  - возможная ротация ключа, переустановка пира или атака подмены.
- `KEY: decrypt failed ...`
  - рассинхрон сессионного ключа, устаревший ключ, поврежденный пакет.
- `KEY: reject invalid public key ...`
  - некорректный/поврежденный ключевой кадр.

6) Поведение автоматики при проблемах
- При частых `decrypt failed` система запрашивает повторный обмен (`reason=decrypt_fail`).
- Локальный rate-limit ограничивает частые KR1 запросы.
- При pinned mismatch авто-инициация ограничена, требуются явные действия.
- При штатном shutdown отправляется broadcast-кадр `KOF1|<id>` для синхронизации app-presence (это не key-rotate и не смена pinned-key).

7) Ручные действия пользователя
- `Send and request public key` — отправить свой и запросить public key пира.
- `Accept` (при конфликте) — принять новый public key вручную.
- `Ignore` (при конфликте) — временно скрыть предупреждение без замены ключа.

8) Рекомендации по безопасной эксплуатации
- Для публичных/шумных сетей использовать `STRICT`.
- Проверять fingerprint ключа вне канала при первом доверии.
- Реагировать на `pinned key mismatch`, не игнорировать по умолчанию.
- Периодически делать rekey сессии (если включен `session_rekey`).
