Руководство пользователя meshTalk (RU)
Версия: 0.4.0
Обновлено: 2026-02-12

1) Что это за приложение
- meshTalk - настольный клиент для экспериментального обмена пакетами данных поверх Meshtastic.
- Поддерживаются два маршрута передачи:
  - протокол meshTalk (MT-WIRE + обмен ключами KR1/KR2),
  - обычный текстовый канал Meshtastic (`TEXT_MESSAGE_APP`).

2) Что нужно для работы
- Python 3.9+
- Установленный пакет/CLI Meshtastic в текущем окружении
- PySide6
- Подключение радио по USB/serial

3) Запуск
- Команда:
  - `python meshTalk.py`
- Порт по умолчанию: `auto`.
- При старте приложение автоматически сканирует serial-порты и подключается.

4) Основной экран
- Левая панель: контакты и группы.
- Правая панель: чат/сообщения.
- Верхняя строка: ID клиента и статусные уведомления.
- Низ окна: поле ввода и кнопка отправки.

5) Контакты и группы
- Диалог контакта: переписка с одним peer.
- `group:Primary`: публичный/широковещательный канал Meshtastic.
- Другие группы: список выбранных контактов.

6) Логика отправки (важно)
- В диалоге контакта:
  - если peer активен в meshTalk и ключи валидны -> отправка по meshTalk-протоколу,
  - иначе -> отправка обычным Meshtastic-текстом.
- В `Primary`:
  - отправка всегда идет широковещательно в `TEXT_MESSAGE_APP`.
- В пользовательских группах:
  - для каждого участника маршрут выбирается индивидуально по его состоянию.

7) Логика приема
- Входящие direct-сообщения Meshtastic показываются в диалоге контакта-отправителя.
- Входящие broadcast-сообщения Meshtastic показываются в `group:Primary`.
- Входящие meshTalk-сообщения показываются в диалоге контакта с расширенным статусом.

8) Строки статуса сообщения
- Для meshTalk: подробный статус (время, попытки, хопы, части, сжатие).
- Для обычного Meshtastic:
  - исходящее: `отправлено в HH:MM`
  - входящее: `пришло в HH:MM`

9) Цвет статуса контакта
- Ярко-зеленый: meshTalk online (валидные ключи + недавняя активность приложения).
- Темно-зеленый: meshTalk offline (приложение было замечено ранее, сейчас офлайн).
- Желтый: онлайн только как Meshtastic-устройство.
- Темно-желтый: был в Meshtastic-сети, сейчас офлайн (видели в пределах 24ч).
- Без индикатора: нет активности более 24 часов.

10) Ключи и безопасность (кратко)
- Обмен ключами: кадры `KR1` / `KR2`.
- Транспорт meshTalk: MT-WIREv1 (AES-256-GCM).
- При конфликте ключа приложение показывает предупреждение и действия.
- В контекстном меню контакта: `Send and request public key` для ручного запроса нового ключа.

11) Оффлайн-сигнал приложения
- При закрытии meshTalk отправляет широковещательный кадр присутствия `KOF1|<id>`.
- Клиенты, которые его получили, сразу переводят этот контакт в offline (без ожидания таймера).

12) Настройки (быстро)
- General: retry/max wait/max bytes/rate/parallel/autopacing.
- Log: уровень подробности и запись runtime.log.
- Discovery: отправка/ответ на broadcast discovery.
- Security: политика смены ключа, session rekey.
- Compression: режим нормализации и компрессии.
- Contacts: фильтры отображения и легенда статусов.

13) Типовые проблемы
- "waiting for radio":
  - проверьте USB-кабель, порт и права на serial-устройство.
- Сообщение не отправляется:
  - смотрите в runtime-логе `ROUTE`, `SEND`, `SENDSTD`, `KEY`, `ACK`, `failed`.
- Не видно обычные сообщения:
  - проверьте `RECVSTD` в логе и правильность маршрута (direct vs `Primary`).
- Конфликт ключа:
  - проверьте предупреждение и выберите действие по вашей политике.

14) Полезные префиксы в runtime-логе
- `ROUTE` -> выбранный маршрут передачи.
- `SEND` / `ACK` -> отправка/подтверждение по meshTalk.
- `SENDSTD` / `RECVSTD` -> обычный Meshtastic-текст.
- `KEY` / `KEYOK` -> обмен ключами.
- `DISCOVERY`, `HEALTH`, `TRACE` -> диагностика сети.
